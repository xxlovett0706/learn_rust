# 智能指针

## 指针语义

行为像指针

```rust
fn main() {
    let x: Box<i32> = Box::new(42);
    let y = *x;
    assert_eq!(y, 42);
}
```

## 内存管理机制

借鉴 Cpp 的 RAII

```rust
unsafe impl<#[may_dangle] T: ?Sized> Drop for Box<T> {
    fn drop(&mut self) {
        // FIXME: Do nothing, drop is currently performed by compiler.
    }
}
```

## trait 决定了类型的行为

1. Deref trait => 拥有指针语义
2. Drop trait => 内存自动管理机制

### Deref trait

```rust
pub trait Deref {
    type Target: ?Sized;
    fn deref(&self) -> &Self::Target;
}

// Box<T> 实现 Deref trait
impl<T: ?Sized> Deref for Box<T> {
    type Target = T;

    fn deref(&self) -> &T {
        &**self
    }
}
```

## 自定义智能指针

```rust
use std::ops::Deref;

struct MySmartPointer<T>(T);

impl<T> MySmartPointer<T> {
  fn new(x:T) -> MySmartPointer<T> {
    MySmartPointer(x)
  }
}

impl<T> Deref for MySmartPointer<T> {
  type Target = T;

  fn deref(&self) -> &T {
     &self.0
  }
}

fn main () {
  let x = 5;
  let y = MySmartPointer::new(x);

  assert_eq!(x, 5);
  assert_eq!(*y, 5);
}
```

## 智能指针只能在何处

1. 可以自动解引用，提升开发体验
2. 可以自动化管理内存，安全无忧

### 自动解引用-点调用操作

```rust
use std::ops::Deref;

struct MySmartPointer<T>(T);

impl<T> MySmartPointer<T> {
    fn new(x: T) -> MySmartPointer<T> {
        MySmartPointer(x)
    }
}

impl<T> Deref for MySmartPointer<T> {
    type Target = T;

    fn deref(&self) -> &T {
        &self.0
    }
}

struct User {
    name: &'static str,
}

impl User {
    fn name(&self) {
        println!("{:?}", self.name);
    }
}

fn main() {
    let u = User { name: "Mask" };
    let y = MySmartPointer::new(u);

    y.name();
}

```

### 自动解引用-函数参数

```rust
fn takes_str(s: &str) {
    println!("{:?}", s); // Hello
}

fn main () {
    let s = String::from("Hello");
    takes_str(&s);
}
```

String 实现了 deref trait

```rust
impl ops::Deref for String {
    type Target = str;

    #[inline]
    fn deref(&self) -> &str {
        unsafe { str::from_utf8_unchecked(&self.vec) }
    }
}
```

### 自动解引用-需要注意的地方

1. 使用 `*x` 这样手工解引用的方式，等价于 `*(x.deref())`
2. 使用**点调用**或者**在函数参数位置**上对 x 自动解引用则是等价于`x.deref()`

## Rust 标准库包含了哪些指针

1. `Box<T>`
2. `Vec<T>` 和 `String`
3. `Rc<T>` 和 `Arc<T>`
4. `HashMap<K, V>`

## 标准库中的实现

```rust
impl<T: ?Sized> Deref for &T {
    type Target = T;

    fn deref(&self) -> &T {
        *self
    }
}

impl<T: ?Sized> !DerefMut for &T {}

impl<T: ?Sized> Deref for &mut T {
    type Target = T;

    fn deref(&self) -> &T {
        *self
    }
}
```
